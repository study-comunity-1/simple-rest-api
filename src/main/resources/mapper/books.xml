<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.study.bookstore.global.mapper.book.BookMapper">

<!--  &lt;!&ndash;DTO에서 받은 데이터를 기반으로 SQL 쿼리를 실행!&ndash;&gt;
  &lt;!&ndash;1.책 추가!&ndash;&gt;
  <insert id="insertBook">
    INSERT INTO books (title, author, publisher, price, stock, published_date, page, category, description, isbn, created_date, updated_date)
    VALUES (#{title}, #{author}, #{publisher}, #{price}, #{stock}, #{publishedDate}, #{page}, #{category}, #{description}, #{isbn}, NOW(), NOW())
  </insert>
  &lt;!&ndash;2.책 수정!&ndash;&gt;
  <update id="updateBook" parameterType="com.study.bookstore.domain.book.entity.Book">
    UPDATE books
    SET
    title = #{title},
    author = #{author},
    publisher = #{publisher},
    price = #{price},
    stock = #{stock},
    published_date = #{publishedDate},
    page = #{page},
    category = #{category},
    description = #{description},
    isbn = #{isbn},
    updated_date = #{updatedDate}
    WHERE id = #{id}
  </update>

  &lt;!&ndash;3.책 삭제!&ndash;&gt;
  <delete id="deleteBook">
    DELETE FROM books WHERE id = #{id}
  </delete>



  &lt;!&ndash;4.모든 책 목록 조회!&ndash;&gt;
  <select id="getBookList" resultType="com.study.bookstore.domain.book.entity.Book">
    SELECT * FROM books
  </select>

  &lt;!&ndash; 총 책 수를 세는 쿼리 &ndash;&gt;
  <select id="getTotalBooks" resultType="Integer">
    SELECT COUNT(*) FROM books
  </select>

  &lt;!&ndash;책 코드로 한 권의 수량을 세는 쿼리 &ndash;&gt;
  <select id="getBookStock" resultType="Integer">
    SELECT COUNT(*) FROM books WHERE isbn = #{isbn}
  </select>

  &lt;!&ndash; 페이지네이션 적용하여 책 목록을 가져오는 쿼리 &ndash;&gt;
  <select id="getBookListPagination" resultType="com.study.bookstore.domain.book.entity.Book">
    SELECT * FROM books
    ORDER BY id DESC
    LIMIT #{pageSize}
    OFFSET #{offset}
  </select>-->


  <select id="findBooks" resultType="com.study.bookstore.domain.book.entity.Book">

    SELECT *
    FROM Books
    WHERE (#{categoryId} IS NULL OR category_id = #{categoryId})
      AND(#{title} IS NULL OR title = #{title})
      AND(#{author} IS NULL OR author = #{author})
    ORDER BY
      CASE
          WHEN #{sort} = 'created_date' THEN created_date
          WHEN #{sort} = 'title' THEN title
          WHEN #{sort} = 'author' THEN author
          ELSE created_date -- 기본 정렬
      END

  </select>


  
</mapper>